<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Conciergerie du Pyla</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
  <!-- FullCalendar CSS (version 5.10.0) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    /* Inspiré des tons et du style de conciergeriedupyla.com */
    body {
      background-color: #fefdf9;
      color: #5c5c5c;
      padding-top: 80px; /* Espace pour le header fixe */
      font-family: 'Helvetica Neue', Arial, sans-serif;
    }

    /* Couleur d'accent inspirée du site (vert/gris doux) */
    :root {
      --accent-color: #7D9C8D; /* Couleur repérée sur conciergeriedupyla.com */
      --accent-color-dark: #587064;
    }

    /* Header / top bar */
    #topBar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 80px;
      background-color: #ffffff;
      border-bottom: 2px solid #dfdfdf;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 2000;
    }
    #topBarLeft {
      display: flex;
      align-items: center;
    }
    /* Logo plus grand */
    #topBarLeft img {
      height: 100px; 
      margin-right: 10px;
      object-fit: contain;
    }
    #topBarLeft h4 {
      font-size: 1.6rem;
      margin: 0;
      font-weight: 600;
      color: #3c3c3c;
    }
    #topBarRight {
      display: flex;
      align-items: center;
    }
    #topBarRight button {
      margin-left: 10px;
    }
    /* Pour afficher le rôle courant */
    #currentRole {
      margin-left: 15px;
      font-weight: 600;
      color: var(--accent-color-dark);
    }

    /* Bande d'image en haut de la page (sous la topBar) */
    #imageBanner {
      width: 100%;
      overflow: hidden;
      margin-bottom: 20px; /* espace sous la bande */
    }
    #imageBanner img {
      width: 100%;
      /* On rogne l'image en limitant la hauteur */
      max-height: 300px;
      display: block;
      object-fit: cover;
    }

    /* Page d'accueil */
    #home {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 50px;
    }
    .house-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 30px;
    }
    .house-box {
      background-color: #ffffff;
      border: 1px solid #ccc;
      padding: 20px;
      margin: 10px;
      width: 220px;
      text-align: center;
      cursor: pointer;
      /* Coins arrondis */
      border-radius: 10px;
      /* Animations au survol */
      transition: background-color 0.3s ease, transform 0.3s ease;
      position: relative;
    }
    .house-box:hover {
      background-color: #f0f0f0;
      transform: scale(1.03);
    }
    .house-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      margin-bottom: 10px;
      border-radius: 10px;
    }
    .delete-house-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 1.2rem;
      color: red;
      cursor: pointer;
      display: none;
    }

    /* Dashboard + Global Stats */
    #dashboardContainer {
      max-width: 1200px;
      width: 100%;
      margin-top: 20px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    #upcomingReservationsTable, #globalStats {
      border: 1px solid #ccc;
      background-color: #ffffff;
      /* Coins arrondis */
      border-radius: 10px;
      padding: 15px;
      margin: 10px;
      width: 500px;
    }

    /* Bouton ajouter une maison */
    #addHouseBtn {
      margin-top: 20px;
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: #fff;
    }
    #addHouseBtn:hover {
      background-color: var(--accent-color-dark);
      border-color: var(--accent-color-dark);
    }

    /* Calendrier global sur la page d'accueil */
    #globalCalendar {
      width: 90%;
      max-width: 1200px;
      margin: 30px 0;
      background-color: #ffffff;
      /* Coins arrondis */
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Page de réservation */
    #reservationPage {
      display: none;
    }
    #calendar {
      margin: 0 auto;
      height: 600px;
      background-color: #ffffff;
      /* Coins arrondis */
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #reservationFormContainer {
      border: 1px solid #ccc;
      /* Coins arrondis */
      border-radius: 10px;
      background-color: #ffffff;
      margin-top: 20px;
      padding: 15px;
    }
    .fc-highlight {
      background-color: rgba(0, 128, 0, 0.3) !important;
    }
    .fc-event {
      cursor: pointer;
    }

    /* Navbar de la page de réservation */
    .navbar {
      position: sticky;
      top: 80px;
      z-index: 1000;
      background-color: #ffffff;
      border-bottom: 1px solid #dfdfdf;
    }
    .navbar-brand {
      font-weight: 600;
      color: #3c3c3c !important;
    }

    /* Check-list */
    #checklistContainer {
      border: 1px solid #ccc;
      /* Coins arrondis */
      border-radius: 10px;
      background-color: #ffffff;
      margin-top: 20px;
      padding: 15px;
    }

    /* Statistiques */
    #statsContainer {
      border: 1px solid #ccc;
      /* Coins arrondis */
      border-radius: 10px;
      background-color: #ffffff;
      margin-top: 20px;
      padding: 15px;
    }

    /* Masquer les boutons d'administration par défaut */
    .admin-only {
      display: none;
    }

    /* Répertoire client */
    #clientDirectoryPage {
      display: none;
      margin-top: 20px;
    }
    .client-card {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 5px;
      /* Coins arrondis */
      border-radius: 10px;
      background-color: #ffffff;
    }

    /* Boutons d'animation (hover) */
    button {
      transition: all 0.2s ease-in-out;
    }
    button:hover {
      transform: scale(1.02);
    }
  </style>
</head>
<body>

  <!-- Top Bar -->
  <div id="topBar">
    <div id="topBarLeft">
      <img 
        src="https://static.wixstatic.com/media/b35bf8_b0c82e53244446c9b867e05b9eb7d5de~mv2.png" 
        alt="Logo Pyla"
      >
      <h4>Conciergerie du Pyla</h4>
    </div>
    <div id="topBarRight">
      <!-- Ajout du span pour le rôle courant -->
      <span id="currentRole"></span>
      <button class="btn btn-primary" onclick="openLoginModal()" id="topBarLoginBtn">
        <i class="bi bi-box-arrow-in-right"></i> S'identifier
      </button>
      <button class="btn btn-secondary" onclick="logout()" style="display: none;" id="topBarLogoutBtn">
        <i class="bi bi-box-arrow-right"></i> Déconnexion
      </button>
      <!-- Boutons Export/Import (admin-only) -->
      <button class="btn btn-success admin-only" onclick="exportData()" style="display:none; margin-left:10px;">
        <i class="bi bi-download"></i> Exporter
      </button>
      <button class="btn btn-info admin-only" onclick="importData()" style="display:none;">
        <i class="bi bi-upload"></i> Importer
      </button>
      <!-- Champ input invisible pour l'import de fichier JSON -->
      <input type="file" id="importFileInput" accept=".json" style="display:none;" onchange="handleImportFile(event)">
    </div>
  </div>

  <!-- Bande d'image en haut de la page -->
  <div id="imageBanner">
    <img 
      src="https://www.jeanphilippebellonphotography.com/img/superbe-coucher-soleil-dune-pilat-panorama-187.webp" 
      alt="Coucher de soleil sur la dune"
    >
  </div>

  <!-- Modal d'identification -->
  <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">S'identifier</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Choix du rôle -->
          <div id="roleSelection">
            <button class="btn btn-success btn-block mb-2" onclick="chooseRole('admin')">Admin</button>
            <button class="btn btn-warning btn-block" onclick="chooseRole('employee')">Employé</button>
          </div>

          <!-- Formulaire Admin (mot de passe) -->
          <div id="adminLoginForm" style="display: none;">
            <div class="form-group">
              <label for="adminPassword"><i class="bi bi-shield-lock"></i> Mot de passe admin</label>
              <!-- Mot de passe = "admin" -->
              <input type="password" class="form-control" id="adminPassword">
            </div>
            <button class="btn btn-primary" onclick="loginAsAdmin()">Se connecter</button>
          </div>

          <!-- Formulaire Employé (nom) -->
          <div id="employeeLoginForm" style="display: none;">
            <div class="form-group">
              <label for="employeeName"><i class="bi bi-person-fill"></i> Nom employé</label>
              <input type="text" class="form-control" id="employeeName">
            </div>
            <button class="btn btn-primary" onclick="loginAsEmployee()">Se connecter</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page d'accueil (choix de la maison + dashboard + calendrier global) -->
  <div id="home" class="container">
    <!-- Bouton pour accéder au répertoire client (uniquement si connecté) -->
    <button id="goClientDirectoryBtn" class="btn btn-warning mb-3" style="display:none;" onclick="showClientDirectory()">
      <i class="bi bi-people-fill"></i> Répertoire Client
    </button>

    <!-- Conteneur des maisons -->
    <div class="house-container" id="houseContainer"></div>

    <!-- Bouton pour ajouter une nouvelle maison (réservé aux admins) -->
    <button id="addHouseBtn" class="btn btn-info admin-only" onclick="addHouse()">
      <i class="bi bi-house-add"></i> Ajouter une maison
    </button>

    <!-- Tableau de bord -->
    <div id="dashboardContainer">
      <!-- Prochaines réservations -->
      <div id="upcomingReservationsTable">
        <h4>Prochaines réservations</h4>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Maison</th>
              <th>Client</th>
              <th>Dates</th>
            </tr>
          </thead>
          <tbody id="upcomingReservationsBody"></tbody>
        </table>
      </div>
      <!-- Statistiques globales -->
      <div id="globalStats">
        <h4>Statistiques Globales</h4>
        <p><i class="bi bi-calendar-check"></i> Nombre total de réservations : <span id="globalResaCount">0</span></p>
        <p><i class="bi bi-cash-coin"></i> Revenu total (toutes maisons) : <span id="globalRevenue">0</span> €</p>
      </div>
    </div>

    <!-- Calendrier global (toujours présent) -->
    <div id="globalCalendar"></div>
  </div>

  <!-- Page de répertoire client -->
  <div id="clientDirectoryPage" class="container">
    <h3>Répertoire Client</h3>
    <button class="btn btn-secondary mb-3" onclick="goHomeFromClientDir()">
      <i class="bi bi-arrow-left-circle"></i> Retour Accueil
    </button>
    <!-- Formulaire pour ajouter un nouveau client -->
    <div class="card mb-3">
      <div class="card-header">Nouveau Client</div>
      <div class="card-body">
        <form id="clientForm">
          <div class="form-group">
            <label for="clientName"><i class="bi bi-person-badge-fill"></i> Nom du Client</label>
            <input type="text" class="form-control" id="clientName" required>
          </div>
          <div class="form-group">
            <label for="clientPlatform"><i class="bi bi-globe"></i> Plateforme (Booking, Airbnb...)</label>
            <input type="text" class="form-control" id="clientPlatform">
          </div>
          <div class="form-group">
            <label for="clientPayment"><i class="bi bi-cash-stack"></i> État du paiement</label>
            <input type="text" class="form-control" id="clientPayment" placeholder="Payé, en attente...">
          </div>
          <div class="form-group">
            <label for="clientNotes"><i class="bi bi-info-circle"></i> Demandes particulières</label>
            <textarea class="form-control" id="clientNotes"></textarea>
          </div>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-person-plus-fill"></i> Ajouter Client
          </button>
        </form>
      </div>
    </div>

    <!-- Liste des clients -->
    <div id="clientList"></div>
  </div>

  <!-- Page de réservation (calendrier + formulaire + check-list + stats) -->
  <div id="reservationPage" class="container">
    <!-- Barre de navigation / bouton de retour -->
    <nav class="navbar navbar-light mb-4">
      <button class="btn btn-secondary" onclick="goHome()">
        <i class="bi bi-arrow-left-circle"></i> Retour à l'accueil
      </button>
      <span class="navbar-brand mb-0 h1" id="currentHouseTitle"></span>
    </nav>

    <div class="row">
      <!-- Zone principale du calendrier (pour la maison sélectionnée) -->
      <div class="col-md-8">
        <div id="calendar"></div>

        <!-- Statistiques simples (pour la maison sélectionnée) -->
        <div id="statsContainer" style="display: none;">
          <h4 class="mb-3">Statistiques</h4>
          <p><i class="bi bi-calendar-check"></i> Nombre de réservations : <span id="statsReservationsCount">0</span></p>
          <p><i class="bi bi-card-checklist"></i> Nombre de tâches : <span id="statsTasksCount">0</span></p>
          <p><i class="bi bi-check-square"></i> Tâches terminées : <span id="statsTasksDone">0</span></p>
          <p><i class="bi bi-cash-coin"></i> Revenu mensuel : <span id="statsMonthlyRevenue">0</span> €</p>
          <p><i class="bi bi-bar-chart-line"></i> Taux d'occupation (mois) : <span id="statsOccupancyRate">0</span>%</p>
          <p><i class="bi bi-bar-chart-line"></i> Taux d'occupation (saison) : <span id="statsSeasonalOccupancyRate">0</span>%</p>
        </div>
      </div>

      <!-- Zone de droite : formulaire d'ajout de réservation + check-list -->
      <div class="col-md-4">
        <!-- Bouton + formulaire d'ajout de réservation -->
        <div id="reservationAction">
          <button 
            id="addResaBtn" 
            class="btn btn-primary btn-block mb-4" 
            onclick="showReservationForm()"
          >
            <i class="bi bi-plus-circle"></i> Ajouter Réservation
          </button>
          <div id="reservationFormContainer" style="display: none;">
            <h4 class="mb-3">Nouvelle réservation</h4>
            <form id="reservationForm">
              <div class="form-group">
                <label for="selectedDates"><i class="bi bi-calendar-event"></i> Dates sélectionnées</label>
                <input type="text" class="form-control" id="selectedDates" readonly>
              </div>
              <!-- Champ 'source' (où a été faite la résa) -->
              <div class="form-group">
                <label for="reservationSource"><i class="bi bi-globe"></i> Source de la réservation</label>
                <input type="text" class="form-control" id="reservationSource" placeholder="Ex: Booking, Airbnb...">
              </div>
              <!-- Choix d'un client existant ou nouveau -->
              <div class="form-group">
                <label for="existingClient"><i class="bi bi-person-check-fill"></i> Client existant ?</label>
                <select class="form-control" id="existingClient">
                  <option value="">-- Nouveau client --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="clientFirstName"><i class="bi bi-person"></i> Prénom</label>
                <input type="text" class="form-control" id="clientFirstName">
              </div>
              <div class="form-group">
                <label for="clientLastName"><i class="bi bi-person-badge"></i> Nom</label>
                <input type="text" class="form-control" id="clientLastName">
              </div>
              <div class="form-group">
                <label for="clientPrice"><i class="bi bi-cash-stack"></i> Prix à la semaine (€)</label>
                <input type="number" class="form-control" id="clientPrice" step="0.01" min="0">
              </div>
              <div class="form-group">
                <label for="clientOccupant"><i class="bi bi-people-fill"></i> Nombre de locataires</label>
                <input type="number" class="form-control" id="clientOccupant" min="1" value="1">
              </div>
              <div class="form-group">
                <label for="clientDoubleBeds"><i class="bi bi-heart-fill"></i> Lit(s) double(s) utilisé(s)</label>
                <input type="number" class="form-control" id="clientDoubleBeds" min="0" value="0">
              </div>
              <div class="form-group">
                <label for="clientSingleBeds"><i class="bi bi-heart"></i> Lit(s) simple(s) utilisé(s)</label>
                <input type="number" class="form-control" id="clientSingleBeds" min="0" value="0">
              </div>
              <div class="form-group">
                <label for="clientInfo"><i class="bi bi-info-circle"></i> Info supplémentaire</label>
                <textarea class="form-control" id="clientInfo"></textarea>
              </div>
              <div class="form-group text-right">
                <button 
                  type="button" 
                  class="btn btn-secondary mr-2" 
                  onclick="cancelReservation()"
                >
                  Annuler
                </button>
                <button type="submit" class="btn btn-success">Valider</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Check-list des tâches (UNE SEULE catégorie) -->
        <div id="checklistContainer" style="display: none;">
          <h4 class="mb-3">Check-list</h4>
          <form id="checklistForm" class="form-inline mb-3">
            <input 
              type="text" 
              class="form-control mr-2" 
              id="checklistInput" 
              placeholder="Nouvelle tâche" 
              required
            >
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i> Ajouter
            </button>
          </form>
          <ul id="tasksList" class="list-group"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour afficher les détails d'une réservation + bouton suppression / édition -->
  <div 
    class="modal fade" 
    id="reservationModal" 
    tabindex="-1" 
    role="dialog" 
    aria-labelledby="reservationModalLabel" 
    aria-hidden="true"
  >
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="reservationModalLabel" class="modal-title">Détails de la Réservation</h5>
          <button 
            type="button" 
            class="close" 
            data-dismiss="modal" 
            aria-label="Fermer"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p><strong><i class="bi bi-globe"></i> Source:</strong> <span id="modalSource"></span></p>
          <p><strong><i class="bi bi-person"></i> Prénom:</strong> <span id="modalFirstName"></span></p>
          <p><strong><i class="bi bi-person-badge"></i> Nom:</strong> <span id="modalLastName"></span></p>
          <p><strong><i class="bi bi-cash-stack"></i> Prix à la semaine:</strong> <span id="modalPrice"></span> €</p>
          <p><strong><i class="bi bi-people-fill"></i> Nombre de locataires:</strong> <span id="modalOccupant"></span></p>
          <p><strong><i class="bi bi-heart-fill"></i> Lits doubles utilisés:</strong> <span id="modalDoubleBeds"></span></p>
          <p><strong><i class="bi bi-heart"></i> Lits simples utilisés:</strong> <span id="modalSingleBeds"></span></p>
          <p><strong><i class="bi bi-moon-stars-fill"></i> Nombre de nuits:</strong> <span id="modalNights"></span></p>
          <p><strong><i class="bi bi-info-circle"></i> Info:</strong> <span id="modalInfo"></span></p>
          <p><strong><i class="bi bi-calendar-date"></i> Dates:</strong> <span id="modalDates"></span></p>
          <p><strong><i class="bi bi-person-check"></i> Ajouté par:</strong> <span id="modalEmployee"></span></p>
        </div>
        <div class="modal-footer">
          <!-- Boutons d'édition / suppression (admin seulement) -->
          <button 
            type="button" 
            class="btn btn-warning admin-only" 
            onclick="editCurrentReservation()"
          >
            <i class="bi bi-pencil-square"></i> Modifier
          </button>
          <button 
            type="button" 
            class="btn btn-danger admin-only" 
            onclick="deleteCurrentReservation()"
          >
            <i class="bi bi-trash"></i> Supprimer
          </button>
          <button 
            type="button" 
            class="btn btn-secondary" 
            data-dismiss="modal"
          >
            Fermer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts jQuery et Bootstrap -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- FullCalendar Scripts (version 5.10.0) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/locales/fr.js"></script>

  <script>
    /****************************************
     *         VARIABLES GLOBALES
     ****************************************/
    let currentHouse = null;
    let calendar = null;         // Calendrier pour la maison sélectionnée
    let globalCalendar = null;   // Calendrier global sur la page d'accueil
    let selectedStart = null;
    let selectedEnd = null;
    let currentRole = null;      // 'admin' ou 'employee'
    let currentEvent = null;
    let isLoggedIn = false;
    let employeeName = "";

    // Réservations par maison
    let reservationsData = {
      "Maison 1": [],
      "Maison 2": [],
      "Maison 3": []
    };

    // Tâches (check-list) par maison
    let tasksData = {};

    // Répertoire client
    let clientDirectory = []; // { name, platform, payment, notes }

    // Couleurs pour le calendrier global (un code couleur par maison)
    const houseColors = {
      "Maison 1": "#2196F3", 
      "Maison 2": "#4CAF50", 
      "Maison 3": "#9C27B0"
    };

    // Photos pour les maisons
    let housesPhotos = {
      "Maison 1": "",
      "Maison 2": "",
      "Maison 3": ""
    };

    /****************************************
     *       INITIALISATION (DOM Ready)
     ****************************************/
    document.addEventListener('DOMContentLoaded', function() {
      // Charger les tâches depuis le localStorage pour chaque maison
      Object.keys(reservationsData).forEach(h => {
        loadTasksFromLocalStorage(h);
      });

      // Afficher la liste des maisons + dashboard
      initializeDefaultHouses();
      renderDashboard();
      renderGlobalStats();

      // Mettre à jour le répertoire client
      updateClientList();

      // Initialiser le calendrier global (toutes maisons)
      initializeGlobalCalendar();
    });

    /****************************************
     *       IMPORT / EXPORT
     ****************************************/
    function exportData() {
      // On regroupe toutes les données dans un objet
      const fullData = {
        reservationsData,
        tasksData,
        clientDirectory,
        housesPhotos
      };
      const dataStr = JSON.stringify(fullData, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "conciergerie_data.json";
      a.click();

      URL.revokeObjectURL(url);
    }

    function importData() {
      // On déclenche le input type=file caché
      const fileInput = document.getElementById("importFileInput");
      fileInput.value = null; // reset
      fileInput.click();
    }

    function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (
            imported.reservationsData &&
            imported.tasksData &&
            imported.clientDirectory &&
            imported.housesPhotos
          ) {
            // On remplace nos structures par celles importées
            reservationsData = imported.reservationsData;
            tasksData = imported.tasksData;
            clientDirectory = imported.clientDirectory;
            housesPhotos = imported.housesPhotos;

            // On rafraîchit tout
            initializeDefaultHouses();
            renderDashboard();
            renderGlobalStats();
            updateClientList();

            if (globalCalendar) {
              globalCalendar.destroy();
              initializeGlobalCalendar();
            }

            alert("Import des données effectué avec succès !");
          } else {
            alert("Le fichier importé ne contient pas les données attendues.");
          }
        } catch (err) {
          alert("Erreur lors de l'import : " + err.message);
        }
      };
      reader.readAsText(file);
    }

    /****************************************
     *       REPERTOIRE CLIENT
     ****************************************/
    const clientDirectoryPage = document.getElementById('clientDirectoryPage');
    const clientListDiv = document.getElementById('clientList');
    const clientForm = document.getElementById('clientForm');

    clientForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('clientName').value.trim();
      const platform = document.getElementById('clientPlatform').value.trim();
      const payment = document.getElementById('clientPayment').value.trim();
      const notes = document.getElementById('clientNotes').value.trim();

      if (!name) {
        alert('Nom du client obligatoire.');
        return;
      }
      clientDirectory.push({
        name: name,
        platform: platform,
        payment: payment,
        notes: notes
      });
      clientForm.reset();
      updateClientList();
      populateExistingClients();
    });

    function updateClientList() {
      clientListDiv.innerHTML = '';
      clientDirectory.forEach((c) => {
        const card = document.createElement('div');
        card.classList.add('client-card');
        card.innerHTML = `
          <h5>${c.name}</h5>
          <p><strong>Plateforme:</strong> ${c.platform || 'N/A'}</p>
          <p><strong>État paiement:</strong> ${c.payment || 'N/A'}</p>
          <p><strong>Notes:</strong> ${c.notes || ''}</p>
        `;
        clientListDiv.appendChild(card);
      });
    }

    function showClientDirectory() {
      if (!isLoggedIn) {
        alert("Veuillez vous connecter d'abord.");
        return;
      }
      document.getElementById('home').style.display = 'none';
      clientDirectoryPage.style.display = 'block';
    }

    function goHomeFromClientDir() {
      clientDirectoryPage.style.display = 'none';
      document.getElementById('home').style.display = 'flex';
    }

    function populateExistingClients() {
      const select = document.getElementById('existingClient');
      select.innerHTML = `<option value="">-- Nouveau client --</option>`;
      clientDirectory.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = c.name;
        select.appendChild(opt);
      });
    }

    /****************************************
     *       DASHBOARD
     ****************************************/
    function renderDashboard() {
      const upcomingBody = document.getElementById('upcomingReservationsBody');
      upcomingBody.innerHTML = '';

      let allResa = [];
      Object.keys(reservationsData).forEach(h => {
        reservationsData[h].forEach(ev => {
          allResa.push({
            house: h,
            start: ev.start,
            end: ev.end,
            client: ev.title
          });
        });
      });
      // On trie par date de début
      allResa.sort((a, b) => new Date(a.start) - new Date(b.start));
      // On ne garde que celles qui sont >= aujourd'hui
      const todayStr = new Date().toISOString().split('T')[0];
      allResa = allResa.filter(r => r.start >= todayStr);

      const nextFive = allResa.slice(0, 5);
      nextFive.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.house}</td>
          <td>${r.client}</td>
          <td>${formatDate(r.start)} - ${formatDate(r.end)}</td>
        `;
        upcomingBody.appendChild(tr);
      });
    }

    function renderGlobalStats() {
      let totalResa = 0;
      let totalRevenu = 0;
      Object.keys(reservationsData).forEach(h => {
        reservationsData[h].forEach(ev => {
          totalResa++;
          const price = parseFloat(ev.extendedProps.price) || 0;
          totalRevenu += price;
        });
      });
      document.getElementById('globalResaCount').textContent = totalResa;
      document.getElementById('globalRevenue').textContent = totalRevenu.toFixed(2);
    }

    /****************************************
     *       MAISONS
     ****************************************/
    function initializeDefaultHouses() {
      const container = document.getElementById('houseContainer');
      container.innerHTML = '';

      Object.keys(reservationsData).forEach(house => {
        const box = document.createElement('div');
        box.className = 'house-box';

        // Icône suppression (admin-only)
        const delIcon = document.createElement('i');
        delIcon.classList.add('bi', 'bi-trash', 'delete-house-icon', 'admin-only');
        delIcon.title = 'Supprimer cette maison';
        delIcon.onclick = function(e) {
          e.stopPropagation();
          deleteHouse(house);
        };
        box.appendChild(delIcon);

        // Au clic, on ouvre la page de réservation pour cette maison
        box.onclick = function() { selectHouse(house); };

        // Affichage éventuel de la photo de la maison
        if (housesPhotos[house]) {
          box.innerHTML += `
            <img 
              src="${housesPhotos[house]}" 
              alt="Photo de ${house}" 
              class="house-image"
            >
            <h4>${house}</h4>
          `;
        } else {
          // Sinon, icône par défaut
          box.innerHTML += `
            <i class="bi bi-image" style="font-size: 50px; display:block; margin-bottom:10px;"></i>
            <h4>${house}</h4>
          `;
        }

        container.appendChild(box);
      });

      // Afficher l'icône de suppression si admin
      if (currentRole === 'admin') {
        Array.from(document.getElementsByClassName('delete-house-icon')).forEach(el => {
          el.style.display = 'block';
        });
      }
    }

    function deleteHouse(house) {
      if (!confirm(`Voulez-vous vraiment supprimer la maison "${house}" ?`)) return;
      delete reservationsData[house];
      delete tasksData[house];
      delete housesPhotos[house];
      initializeDefaultHouses();
      renderDashboard();
      renderGlobalStats();

      // Re-init le calendrier global
      if (globalCalendar) {
        globalCalendar.destroy();
        initializeGlobalCalendar();
      }
    }

    /****************************************
     *       CALENDRIER GLOBAL (toutes maisons)
     ****************************************/
    function initializeGlobalCalendar() {
      const globalCalendarEl = document.getElementById('globalCalendar');
      if (!globalCalendarEl) return; // Sécurité

      // On construit la liste d'événements "fusionnée" de toutes les maisons
      let allEvents = [];
      Object.keys(reservationsData).forEach(house => {
        (reservationsData[house] || []).forEach(ev => {
          let cloned = {
            title: ev.title + " (" + house + ")",
            start: ev.start,
            end: ev.end,
            color: houseColors[house] || "#000",
            extendedProps: {
              ...ev.extendedProps,
              house: house
            }
          };
          allEvents.push(cloned);
        });
      });

      // Création du calendrier global
      globalCalendar = new FullCalendar.Calendar(globalCalendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek'
        },
        locale: 'fr',
        firstDay: 1,
        selectable: false,
        dayMaxEvents: true,
        height: 'auto',
        events: allEvents
      });

      globalCalendar.render();
    }

    /****************************************
     *       MODAL LOGIN
     ****************************************/
    function openLoginModal() {
      if (isLoggedIn) {
        alert("Vous êtes déjà connecté.");
        return;
      }
      resetLoginForms();
      $('#loginModal').modal('show');
    }

    function resetLoginForms() {
      document.getElementById('roleSelection').style.display = 'block';
      document.getElementById('adminLoginForm').style.display = 'none';
      document.getElementById('employeeLoginForm').style.display = 'none';
    }

    function chooseRole(role) {
      document.getElementById('roleSelection').style.display = 'none';
      if (role === 'admin') {
        document.getElementById('adminLoginForm').style.display = 'block';
      } else {
        document.getElementById('employeeLoginForm').style.display = 'block';
      }
    }

    function loginAsAdmin() {
      const adminPassword = document.getElementById('adminPassword').value;
      if (adminPassword === 'admin') {
        currentRole = 'admin';
        isLoggedIn = true;
        employeeName = "ADMIN";

        const currentRoleEl = document.getElementById('currentRole');
        if (currentRoleEl) {
          currentRoleEl.textContent = 'Connecté en tant qu’Admin';
        }

        document.getElementById('topBarLogoutBtn').style.display = 'inline-block';
        document.getElementById('topBarLoginBtn').style.display = 'none';

        Array.from(document.getElementsByClassName('admin-only')).forEach(el => {
          el.style.display = 'inline-block';
        });
        Array.from(document.getElementsByClassName('delete-house-icon')).forEach(el => {
          el.style.display = 'block';
        });
        document.getElementById('goClientDirectoryBtn').style.display = 'inline-block';

        // On rend visible les boutons d'export/import
        document.querySelectorAll('.admin-only').forEach(btn => btn.style.display = 'inline-block');

        $('#loginModal').modal('hide');
      } else {
        alert("Mot de passe incorrect !");
      }
    }

    function loginAsEmployee() {
      const name = document.getElementById('employeeName').value.trim();
      if (!name) {
        alert("Veuillez saisir un nom.");
        return;
      }
      currentRole = 'employee';
      isLoggedIn = true;
      employeeName = name;

      const currentRoleEl = document.getElementById('currentRole');
      if (currentRoleEl) {
        currentRoleEl.textContent = 'Connecté en tant qu’Employé : ' + employeeName;
      }

      document.getElementById('topBarLogoutBtn').style.display = 'inline-block';
      document.getElementById('topBarLoginBtn').style.display = 'none';

      // Masquer les fonctions admin
      Array.from(document.getElementsByClassName('admin-only')).forEach(el => {
        el.style.display = 'none';
      });
      Array.from(document.getElementsByClassName('delete-house-icon')).forEach(el => {
        el.style.display = 'none';
      });
      document.getElementById('goClientDirectoryBtn').style.display = 'inline-block';

      $('#loginModal').modal('hide');
    }

    function logout() {
      currentRole = null;
      isLoggedIn = false;
      employeeName = "";

      const currentRoleEl = document.getElementById('currentRole');
      if (currentRoleEl) {
        currentRoleEl.textContent = '';
      }

      document.getElementById('topBarLogoutBtn').style.display = 'none';
      document.getElementById('topBarLoginBtn').style.display = 'inline-block';

      Array.from(document.getElementsByClassName('admin-only')).forEach(el => {
        el.style.display = 'none';
      });
      Array.from(document.getElementsByClassName('delete-house-icon')).forEach(el => {
        el.style.display = 'none';
      });
      document.getElementById('goClientDirectoryBtn').style.display = 'none';

      alert("Vous êtes déconnecté.");
    }

    /****************************************
     *       ALLER/RETOUR
     ****************************************/
    function goHome() {
      document.getElementById('reservationPage').style.display = 'none';
      document.getElementById('clientDirectoryPage').style.display = 'none';
      document.getElementById('home').style.display = 'flex';
      currentHouse = null;
      currentEvent = null;
      renderDashboard();
      renderGlobalStats();

      // Re-init le calendrier global
      if (globalCalendar) {
        globalCalendar.destroy();
        initializeGlobalCalendar();
      }
    }

    /****************************************
     *       FORMULAIRE DE RÉSERVATION
     ****************************************/
    document.getElementById('reservationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const firstName = document.getElementById('clientFirstName').value;
      const lastName = document.getElementById('clientLastName').value;
      const info = document.getElementById('clientInfo').value;
      const price = document.getElementById('clientPrice').value;
      const occupant = document.getElementById('clientOccupant').value;
      const doubleBeds = document.getElementById('clientDoubleBeds').value;
      const singleBeds = document.getElementById('clientSingleBeds').value;
      const source = document.getElementById('reservationSource').value || 'N/A';
      const existingClientSelect = document.getElementById('existingClient').value;

      let finalFirstName = firstName;
      let finalLastName = lastName;

      // Si un client existant est sélectionné, on l'utilise
      if (existingClientSelect) {
        const found = clientDirectory.find(c => c.name === existingClientSelect);
        if (found) {
          finalFirstName = found.name; // On stocke son nom dans "firstName"
        }
      } else {
        // Sinon, on ajoute un nouveau client dans le répertoire si champ rempli
        if (firstName || lastName) {
          const newClientName = (firstName + ' ' + lastName).trim();
          if (newClientName) {
            clientDirectory.push({
              name: newClientName,
              platform: source,
              payment: '',
              notes: info
            });
            updateClientList();
            populateExistingClients();
          }
        }
      }

      const newEvent = {
        title: finalFirstName + ' ' + finalLastName,
        start: selectedStart,
        end: selectedEnd,
        color: '#FF4500',
        extendedProps: {
          source: source,
          firstName: finalFirstName,
          lastName: finalLastName,
          price: price,
          occupant: occupant,
          doubleBeds: doubleBeds,
          singleBeds: singleBeds,
          info: info,
          employee: employeeName
        }
      };

      // On ajuste la date de fin pour que FullCalendar l'interprète correctement
      const endDate = new Date(newEvent.end);
      endDate.setDate(endDate.getDate() + 1);
      newEvent.end = endDate.toISOString().split('T')[0];

      // On stocke la réservation dans le tableau correspondant à la maison
      reservationsData[currentHouse].push(newEvent);
      // On l'ajoute également sur le calendrier local
      calendar.addEvent(newEvent);

      // Reset du formulaire
      document.getElementById('reservationForm').reset();
      document.getElementById('reservationFormContainer').style.display = 'none';
      document.getElementById('addResaBtn').style.display = 'block';

      selectedStart = null;
      selectedEnd = null;
      calendar.unselect();

      // Mise à jour des stats et du dashboard
      updateStats();
      renderDashboard();
      renderGlobalStats();

      // Mise à jour du calendrier global
      if (globalCalendar) {
        globalCalendar.destroy();
        initializeGlobalCalendar();
      }
    });

    /****************************************
     *       SÉLECTION D'UNE MAISON
     ****************************************/
    function selectHouse(house) {
      if (!isLoggedIn) {
        alert("Veuillez d'abord vous identifier.");
        return;
      }
      currentHouse = house;
      document.getElementById('home').style.display = 'none';
      document.getElementById('clientDirectoryPage').style.display = 'none';
      document.getElementById('reservationPage').style.display = 'block';
      document.getElementById('currentHouseTitle').textContent = house;

      loadTasksFromLocalStorage(house);
      renderTasks(house);

      document.getElementById('checklistContainer').style.display = 'block';
      document.getElementById('statsContainer').style.display = 'block';
      updateStats();

      // On attend un court instant puis on initialise le calendrier de la maison
      setTimeout(initializeCalendar, 100);
    }

    /****************************************
     *       INITIALISATION DU CALENDRIER (Maison)
     ****************************************/
    function initializeCalendar() {
      const calendarEl = document.getElementById('calendar');
      if (!calendarEl) return;

      // On détruit le précédent calendrier s'il existe
      if (calendar) {
        calendar.destroy();
      }

      // On crée un nouveau calendrier FullCalendar pour la maison sélectionnée
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek'
        },
        locale: 'fr',
        firstDay: 1,
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        height: 'auto',

        // On met à jour les stats quand on change de mois
        datesSet: function(info) {
          updateStats();
        },

        select: function(info) {
          selectedStart = info.startStr;
          const endDate = new Date(info.end);
          endDate.setDate(endDate.getDate() - 1);
          selectedEnd = endDate.toISOString().split('T')[0];

          document.getElementById('selectedDates').value = formatDate(selectedStart) + " - " + formatDate(selectedEnd);
          showReservationForm();
        },
        events: reservationsData[currentHouse] || [],
        eventClick: function(info) {
          currentEvent = info.event;
          const ext = info.event.extendedProps;

          document.getElementById('modalSource').textContent = ext.source || 'N/A';
          document.getElementById('modalFirstName').textContent = ext.firstName || '';
          document.getElementById('modalLastName').textContent = ext.lastName || '';
          document.getElementById('modalPrice').textContent = ext.price || '0';
          document.getElementById('modalOccupant').textContent = ext.occupant || '1';
          document.getElementById('modalDoubleBeds').textContent = ext.doubleBeds || '0';
          document.getElementById('modalSingleBeds').textContent = ext.singleBeds || '0';

          const startD = new Date(info.event.start);
          let endD = info.event.end ? new Date(info.event.end) : startD;
          endD.setDate(endD.getDate() - 1);
          const nights = Math.ceil((endD - startD) / 86400000) || 1;
          document.getElementById('modalNights').textContent = nights;

          document.getElementById('modalInfo').textContent = ext.info || 'Aucune';

          const startDate = formatDate(info.event.start);
          let endDate;
          if (info.event.end) {
            const end = new Date(info.event.end);
            end.setDate(end.getDate() - 1);
            endDate = formatDate(end);
          } else {
            endDate = startDate; 
          }
          document.getElementById('modalDates').textContent = startDate + " - " + endDate;
          document.getElementById('modalEmployee').textContent = ext.employee || 'Inconnu';

          // On affiche la modal
          $('#reservationModal').modal('show');
        }
      });

      calendar.render();
    }

    /****************************************
     *       FORMATER LES DATES
     ****************************************/
    function formatDate(date) {
      if (typeof date === 'string') {
        date = new Date(date);
      }
      return date.toLocaleDateString('fr-FR');
    }

    /****************************************
     *       FORMULAIRE DE RÉSERVATION
     ****************************************/
    function showReservationForm() {
      if (!selectedStart || !selectedEnd) {
        alert("Veuillez sélectionner une plage de dates sur le calendrier.");
        return;
      }
      document.getElementById('reservationFormContainer').style.display = 'block';
      document.getElementById('addResaBtn').style.display = 'none';
      populateExistingClients();
    }

    function cancelReservation() {
      document.getElementById('reservationForm').reset();
      document.getElementById('reservationFormContainer').style.display = 'none';
      document.getElementById('addResaBtn').style.display = 'block';
      selectedStart = null;
      selectedEnd = null;
      if (calendar) {
        calendar.unselect();
      }
    }

    /****************************************
     *       SUPPRESSION / ÉDITION RÉSERVATION
     ****************************************/
    function deleteCurrentReservation() {
      if (currentRole !== 'admin') {
        alert("Seul un admin peut supprimer une réservation.");
        return;
      }
      if (!currentEvent) return;

      // On cherche l'index de la réservation dans le tableau
      const arr = reservationsData[currentHouse];
      const idx = arr.findIndex(ev => 
        ev.title === currentEvent.title &&
        ev.start === currentEvent.startStr &&
        ev.end === (currentEvent.endStr || currentEvent.startStr)
      );
      if (idx !== -1) {
        arr.splice(idx, 1);
      }
      currentEvent.remove();
      currentEvent = null;
      $('#reservationModal').modal('hide');
      updateStats();
      renderDashboard();
      renderGlobalStats();

      // Mettre à jour le calendrier global
      if (globalCalendar) {
        globalCalendar.destroy();
        initializeGlobalCalendar();
      }
    }

    function editCurrentReservation() {
      if (currentRole !== 'admin') {
        alert("Seul un admin peut modifier une réservation.");
        return;
      }
      if (!currentEvent) return;

      // On ferme la modal de détails
      $('#reservationModal').modal('hide');

      const ext = currentEvent.extendedProps;
      const start = currentEvent.startStr;
      let end = currentEvent.endStr;
      if (!end) end = start;

      // On recalcule la date de fin réelle (pour compenser la logique FullCalendar)
      const endDate = new Date(end);
      endDate.setDate(endDate.getDate() - 1);
      const realEndStr = endDate.toISOString().split('T')[0];

      // On stocke ces dates globalement
      selectedStart = start;
      selectedEnd = realEndStr;

      // On remplit le formulaire
      document.getElementById('selectedDates').value = formatDate(start) + ' - ' + formatDate(realEndStr);
      document.getElementById('reservationSource').value = ext.source || 'N/A';
      document.getElementById('clientFirstName').value = ext.firstName || '';
      document.getElementById('clientLastName').value = ext.lastName || '';
      document.getElementById('clientInfo').value = ext.info || '';
      document.getElementById('clientPrice').value = ext.price || '0';
      document.getElementById('clientOccupant').value = ext.occupant || '1';
      document.getElementById('clientDoubleBeds').value = ext.doubleBeds || '0';
      document.getElementById('clientSingleBeds').value = ext.singleBeds || '0';

      // On supprime l'ancien événement
      deleteCurrentReservation();
      // Puis on ré-affiche le formulaire pour le recréer
      showReservationForm();
    }

    /****************************************
     *       CHECK-LIST
     ****************************************/
    const checklistForm = document.getElementById('checklistForm');
    const checklistInput = document.getElementById('checklistInput');
    const tasksList = document.getElementById('tasksList');

    checklistForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const text = checklistInput.value.trim();
      if (!text) return;

      tasksData[currentHouse].push({
        text: text,
        done: false
      });
      saveTasksToLocalStorage(currentHouse);
      renderTasks(currentHouse);
      checklistInput.value = '';
    });

    function renderTasks(house) {
      tasksList.innerHTML = '';
      if (!tasksData[house]) {
        tasksData[house] = [];
      }
      tasksData[house].forEach((task, index) => {
        const li = document.createElement('li');
        li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');

        const leftDiv = document.createElement('div');
        leftDiv.classList.add('d-flex', 'align-items-center');

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = task.done;
        checkbox.classList.add('mr-2');
        checkbox.addEventListener('change', () => {
          tasksData[house][index].done = checkbox.checked;
          saveTasksToLocalStorage(house);

          if (checkbox.checked) {
            span.style.textDecoration = 'line-through';
          } else {
            span.style.textDecoration = 'none';
          }
          updateStats();
        });
        leftDiv.appendChild(checkbox);

        const span = document.createElement('span');
        span.textContent = task.text;
        if (task.done) {
          span.style.textDecoration = 'line-through';
        }
        leftDiv.appendChild(span);

        li.appendChild(leftDiv);

        // Si on est admin, on affiche l'icône de suppression
        if (currentRole === 'admin') {
          const delIcon = document.createElement('i');
          delIcon.classList.add('bi', 'bi-trash', 'text-danger');
          delIcon.style.cursor = 'pointer';
          delIcon.title = 'Supprimer la tâche';
          delIcon.addEventListener('click', () => {
            if (confirm(`Supprimer la tâche "${task.text}" ?`)) {
              tasksData[house].splice(index, 1);
              saveTasksToLocalStorage(house);
              renderTasks(house);
            }
          });
          li.appendChild(delIcon);
        }
        tasksList.appendChild(li);
      });
      updateStats();
    }

    function loadTasksFromLocalStorage(house) {
      const stored = localStorage.getItem('tasks-' + house);
      if (stored) {
        tasksData[house] = JSON.parse(stored);
      } else {
        tasksData[house] = [];
      }
    }
    function saveTasksToLocalStorage(house) {
      localStorage.setItem('tasks-' + house, JSON.stringify(tasksData[house]));
    }

    /****************************************
     *       STATISTIQUES
     ****************************************/
    function updateStats() {
      if (!currentHouse || !calendar) return;

      // Date actuellement affichée par le calendrier (pour la maison)
      const displayedDate = calendar.getDate();

      // Nombre de réservations
      const reservationsCount = reservationsData[currentHouse].length;
      // Tâches
      const tasksCount = tasksData[currentHouse].length;
      const tasksDone = tasksData[currentHouse].filter(t => t.done).length;

      document.getElementById('statsReservationsCount').textContent = reservationsCount;
      document.getElementById('statsTasksCount').textContent = tasksCount;
      document.getElementById('statsTasksDone').textContent = tasksDone;

      // Calcule les stats mensuelles (mois affiché)
      const { revenue, occupancy } = computeMonthlyStats(currentHouse, displayedDate);
      document.getElementById('statsMonthlyRevenue').textContent = revenue;
      document.getElementById('statsOccupancyRate').textContent = occupancy;

      // Taux d'occupation (saison)
      const seasonalOcc = computeSeasonalStats(currentHouse);
      document.getElementById('statsSeasonalOccupancyRate').textContent = seasonalOcc;
    }

    function computeMonthlyStats(house, referenceDate) {
      const year = referenceDate.getFullYear();
      const month = referenceDate.getMonth();
      const firstOfMonth = new Date(year, month, 1);
      const lastOfMonth = new Date(year, month + 1, 0);
      const totalDays = lastOfMonth.getDate();

      let dailyOccupancy = new Array(totalDays).fill(false);
      let totalRevenue = 0;

      (reservationsData[house] || []).forEach(ev => {
        let evStart = new Date(ev.start);
        let evEnd = new Date(ev.end);
        evEnd.setDate(evEnd.getDate() - 1);
        if (evEnd < evStart) evEnd = evStart;

        // Chevauchement avec le mois affiché
        if (evEnd >= firstOfMonth && evStart <= lastOfMonth) {
          const price = parseFloat(ev.extendedProps.price) || 0;
          totalRevenue += price;

          const startDay = Math.max(evStart.getTime(), firstOfMonth.getTime());
          const endDay = Math.min(evEnd.getTime(), lastOfMonth.getTime());
          for (let d = startDay; d <= endDay; d += 86400000) {
            const dayIndex = new Date(d).getDate() - 1; 
            dailyOccupancy[dayIndex] = true;
          }
        }
      });

      const occupiedDays = dailyOccupancy.filter(Boolean).length;
      const occupancyRate = ((occupiedDays / totalDays) * 100).toFixed(1);

      return {
        revenue: totalRevenue.toFixed(2),
        occupancy: occupancyRate
      };
    }

    function computeSeasonalStats(house) {
      const now = new Date();
      const year = now.getFullYear();
      // Saison : Juin (5) à Août (7)
      const seasonStart = new Date(year, 5, 1);
      const seasonEnd = new Date(year, 7, 31);
      const totalDays = Math.round((seasonEnd - seasonStart) / 86400000) + 1;

      let dailyOccupancy = new Array(totalDays).fill(false);

      (reservationsData[house] || []).forEach(ev => {
        let evStart = new Date(ev.start);
        let evEnd = new Date(ev.end);
        evEnd.setDate(evEnd.getDate() - 1);
        if (evEnd < evStart) evEnd = evStart;

        if (evEnd >= seasonStart && evStart <= seasonEnd) {
          const startDay = Math.max(evStart.getTime(), seasonStart.getTime());
          const endDay = Math.min(evEnd.getTime(), seasonEnd.getTime());
          for (let d = startDay; d <= endDay; d += 86400000) {
            const dayIndex = Math.round((d - seasonStart.getTime()) / 86400000);
            if (dayIndex >= 0 && dayIndex < totalDays) {
              dailyOccupancy[dayIndex] = true;
            }
          }
        }
      });

      const occupiedDays = dailyOccupancy.filter(Boolean).length;
      const occupancyRate = ((occupiedDays / totalDays) * 100).toFixed(1);
      return occupancyRate;
    }
  </script>
</body>
</html>